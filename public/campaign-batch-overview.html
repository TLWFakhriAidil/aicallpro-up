<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campaign Batch Call Overview</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f5f6fa; 
      margin: 0; 
      padding: 20px; 
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h2 { color: #273c75; margin-bottom: 20px; }
    
    /* Filters */
    .filters { 
      background: white; 
      padding: 16px; 
      border-radius: 8px; 
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .filters input { 
      padding: 8px 12px; 
      border: 1px solid #dcdde1; 
      border-radius: 4px; 
      margin-right: 10px;
      font-size: 14px;
    }
    .filters button {
      background: #246bfd; 
      color: white; 
      border: none; 
      padding: 8px 20px; 
      border-radius: 4px; 
      cursor: pointer;
      font-size: 14px;
    }
    .filters button:hover { background: #3c8ff6; }

    /* Table */
    .table-wrapper {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
    }
    th, td { 
      padding: 14px 12px; 
      text-align: left; 
      border-bottom: 1px solid #f1f2f6;
    }
    th { 
      background: #e1eaff; 
      color: #273c75;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }
    tr:hover { background: #fafbff; }
    td { font-size: 14px; color: #2f3640; }
    
    /* Badges */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-success { background: #e8f8f5; color: #27ae60; }
    .badge-danger { background: #fdeaea; color: #e74c3c; }
    
    /* Buttons */
    button.view-btn { 
      background: #246bfd; 
      color: white; 
      border: none; 
      padding: 6px 16px; 
      border-radius: 4px; 
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    button.view-btn:hover { 
      background: #3c8ff6; 
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(36, 107, 253, 0.3);
    }
    
    /* Modal */
    #overlay { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100vw; 
      height: 100vh; 
      background: rgba(0,0,0,0.5); 
      z-index: 80;
      backdrop-filter: blur(2px);
    }
    #detailModal { 
      display: none;
      position: fixed; 
      top: 50%; 
      left: 50%; 
      background: #fff; 
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      border-radius: 12px; 
      box-shadow: 0 10px 40px rgba(39, 60, 117, 0.3); 
      transform: translate(-50%, -50%); 
      z-index: 99;
      overflow: hidden;
    }
    #detailModal .modal-header {
      background: linear-gradient(135deg, #246bfd 0%, #3c8ff6 100%);
      color: white;
      padding: 20px;
      position: relative;
    }
    #detailModal .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }
    #detailModal .close { 
      position: absolute; 
      top: 15px; 
      right: 15px; 
      cursor: pointer; 
      background: rgba(255,255,255,0.2); 
      color: #fff; 
      width: 30px;
      height: 30px;
      border: none; 
      border-radius: 50%;
      font-size: 20px;
      line-height: 30px;
      text-align: center;
      transition: all 0.2s;
    }
    #detailModal .close:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    #detailModal .modal-body {
      padding: 20px;
      overflow-y: auto;
      max-height: calc(80vh - 80px);
    }
    .stat-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      flex: 1;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card .label {
      font-size: 12px;
      color: #7f8c8d;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
      color: #2f3640;
    }
    
    /* Call List */
    .call-list {
      margin-top: 20px;
    }
    .call-list h4 {
      color: #273c75;
      margin-bottom: 12px;
      font-size: 16px;
    }
    .call-item {
      background: #f8f9fa;
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 6px;
      border-left: 3px solid #246bfd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .call-item .phone {
      font-weight: 600;
      color: #2f3640;
    }
    .call-item .status {
      font-size: 12px;
    }
    .call-item .time {
      font-size: 11px;
      color: #95a5a6;
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
    }
    .pagination button {
      background: #246bfd;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .pagination button:disabled {
      background: #dcdde1;
      cursor: not-allowed;
    }
    .pagination span {
      color: #2f3640;
      font-size: 14px;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #7f8c8d;
    }
    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìû Campaign Batch Call Overview</h2>
    
    <!-- Filters -->
    <div class="filters">
      <input type="text" id="filterCampaignName" placeholder="Cari nama kempen..." />
      <input type="date" id="filterDate" />
      <button onclick="loadBatchList()">üîç Cari</button>
      <button onclick="resetFilters()">üîÑ Reset</button>
    </div>
    
    <!-- Table -->
    <div class="table-wrapper">
      <table id="batchTable">
        <thead>
          <tr>
            <th>Batch ID</th>
            <th>Nama Kempen</th>
            <th>Total Call</th>
            <th>Success</th>
            <th>Fail</th>
            <th>Dibuat</th>
            <th>Dikemaskini</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="batchTbody">
          <tr>
            <td colspan="8" class="loading">Memuatkan data...</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    <div class="pagination">
      <button id="prevBtn" onclick="prevPage()" disabled>‚Üê Sebelum</button>
      <span id="pageInfo">Halaman 1</span>
      <button id="nextBtn" onclick="nextPage()">Seterus ‚Üí</button>
    </div>
  </div>

  <!-- Modal Overlay -->
  <div id="overlay" onclick="closeDetail()"></div>
  
  <!-- Detail Modal -->
  <div id="detailModal">
    <div class="modal-header">
      <h3 id="modalTitle">Detail Batch</h3>
      <button class="close" onclick="closeDetail()">√ó</button>
    </div>
    <div class="modal-body" id="detailContent">
      <div class="loading">Memuatkan...</div>
    </div>
  </div>

  <script>
    // ========================================
    // CONFIGURATION - Gantikan dengan nilai sebenar
    // ========================================
    const CONFIG = {
      // URL Supabase Edge Function
      API_BASE_URL: 'https://ephpobvbzlemgixverve.supabase.co/functions/v1',
      
      // Supabase Anon Key (public key - safe untuk client-side)
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwaHBvYnZiemxlbWdpeHZlcnZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNDU5NzUsImV4cCI6MjA3NDYyMTk3NX0.Y-g89AZkXvP9kOQnwEr4QLyoFsY8F3FRpmibaJVSG7k',
      
      // User ID - GANTIKAN dengan user ID anda dari table users
      // Untuk dapatkan user_id, run query: SELECT id, username FROM users;
      USER_ID: 'YOUR_USER_ID_HERE',
      
      // Pagination
      PAGE_SIZE: 20
    };

    // ========================================
    // STATE MANAGEMENT
    // ========================================
    let currentPage = 1;
    let totalPages = 1;

    // ========================================
    // LOAD BATCH LIST
    // ========================================
    function loadBatchList() {
      const campaignName = document.getElementById('filterCampaignName').value.trim();
      const date = document.getElementById('filterDate').value;
      
      // Build query params
      const params = new URLSearchParams({
        user_id: CONFIG.USER_ID,
        page: currentPage,
        size: CONFIG.PAGE_SIZE
      });
      
      if (campaignName) params.append('campaign_name', campaignName);
      if (date) params.append('date', date);
      
      const url = `${CONFIG.API_BASE_URL}/campaign-batch-list?${params.toString()}`;
      
      // Show loading
      document.getElementById('batchTbody').innerHTML = 
        '<tr><td colspan="8" class="loading">Memuatkan data...</td></tr>';
      
      fetch(url, {
        method: 'GET',
        headers: {
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(result => {
        const { data, pagination } = result;
        
        // Update pagination info
        if (pagination) {
          totalPages = pagination.total_pages;
          document.getElementById('pageInfo').textContent = 
            `Halaman ${pagination.page} / ${pagination.total_pages} (Total: ${pagination.total})`;
          
          // Update buttons
          document.getElementById('prevBtn').disabled = pagination.page <= 1;
          document.getElementById('nextBtn').disabled = pagination.page >= pagination.total_pages;
        }
        
        // Render table
        renderBatchTable(data);
      })
      .catch(error => {
        console.error('Error loading batch list:', error);
        document.getElementById('batchTbody').innerHTML = 
          `<tr><td colspan="8" style="text-align:center; color:#e74c3c; padding:40px;">
            ‚ö†Ô∏è Gagal memuatkan data. <br><small>${error.message}</small>
          </td></tr>`;
      });
    }

    // ========================================
    // RENDER TABLE
    // ========================================
    function renderBatchTable(data) {
      const tbody = document.getElementById('batchTbody');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <div>Tiada data ditemui</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = data.map(row => `
        <tr>
          <td><strong>#${row.batch_id}</strong></td>
          <td>${row.campaign_name || '-'}</td>
          <td><strong>${row.total_calls || 0}</strong></td>
          <td><span class="badge badge-success">${row.successful_calls || 0}</span></td>
          <td><span class="badge badge-danger">${row.failed_calls || 0}</span></td>
          <td><small>${formatDateTime(row.created_at)}</small></td>
          <td><small>${formatDateTime(row.updated_at)}</small></td>
          <td>
            <button class="view-btn" onclick="viewDetail('${row.batch_id}')">
              üëÅÔ∏è View
            </button>
          </td>
        </tr>
      `).join('');
    }

    // ========================================
    // VIEW DETAIL
    // ========================================
    function viewDetail(batchId) {
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('detailModal').style.display = 'block';
      document.getElementById('detailContent').innerHTML = '<div class="loading">Memuatkan detail...</div>';
      
      const url = `${CONFIG.API_BASE_URL}/campaign-batch-detail/${batchId}?user_id=${CONFIG.USER_ID}`;
      
      fetch(url, {
        method: 'GET',
        headers: {
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        renderBatchDetail(data);
      })
      .catch(error => {
        console.error('Error loading detail:', error);
        document.getElementById('detailContent').innerHTML = 
          `<div style="text-align:center; color:#e74c3c; padding:40px;">
            ‚ö†Ô∏è Gagal memuatkan detail. <br><small>${error.message}</small>
          </div>`;
      });
    }

    // ========================================
    // RENDER DETAIL
    // ========================================
    function renderBatchDetail(data) {
      document.getElementById('modalTitle').textContent = 
        `${data.campaign_name} (Batch #${data.batch_id})`;
      
      const successRate = data.total_calls > 0 
        ? ((data.successful_calls / data.total_calls) * 100).toFixed(1) 
        : 0;
      
      let html = `
        <div class="stat-row">
          <div class="stat-card">
            <div class="label">Total Calls</div>
            <div class="value">${data.total_calls || 0}</div>
          </div>
          <div class="stat-card">
            <div class="label">Success</div>
            <div class="value" style="color: #27ae60;">${data.successful_calls || 0}</div>
          </div>
          <div class="stat-card">
            <div class="label">Failed</div>
            <div class="value" style="color: #e74c3c;">${data.failed_calls || 0}</div>
          </div>
          <div class="stat-card">
            <div class="label">Success Rate</div>
            <div class="value" style="color: #246bfd;">${successRate}%</div>
          </div>
        </div>
        
        <div style="margin-bottom: 15px;">
          <small style="color: #7f8c8d;">
            üìÖ Dibuat: ${formatDateTime(data.created_at)}<br>
            üîÑ Dikemaskini: ${formatDateTime(data.updated_at)}
          </small>
        </div>
        
        <div class="call-list">
          <h4>üìû Senarai Panggilan (${data.calls?.length || 0})</h4>
      `;
      
      if (data.calls && data.calls.length > 0) {
        html += data.calls.map(call => `
          <div class="call-item">
            <div>
              <div class="phone">üì± ${call.phone_number}</div>
              <div class="time">${formatDateTime(call.call_time)}</div>
            </div>
            <div class="status">
              <span class="badge ${call.call_status === 'Success' ? 'badge-success' : 'badge-danger'}">
                ${call.call_status}
              </span>
            </div>
          </div>
        `).join('');
      } else {
        html += '<div class="empty-state"><small>Tiada call details tersedia.</small></div>';
      }
      
      html += '</div>';
      
      document.getElementById('detailContent').innerHTML = html;
    }

    // ========================================
    // CLOSE MODAL
    // ========================================
    function closeDetail() {
      document.getElementById('detailModal').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    // ========================================
    // PAGINATION
    // ========================================
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        loadBatchList();
      }
    }

    function nextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        loadBatchList();
      }
    }

    // ========================================
    // RESET FILTERS
    // ========================================
    function resetFilters() {
      document.getElementById('filterCampaignName').value = '';
      document.getElementById('filterDate').value = '';
      currentPage = 1;
      loadBatchList();
    }

    // ========================================
    // UTILITY: FORMAT DATETIME
    // ========================================
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      // Already in format "YYYY-MM-DD HH:mm:ss" from API
      return dateStr.replace('T', ' ').substring(0, 19);
    }

    // ========================================
    // INIT - Load data on page load
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      // Check if User ID is configured
      if (CONFIG.USER_ID === 'YOUR_USER_ID_HERE') {
        document.getElementById('batchTbody').innerHTML = 
          `<tr><td colspan="8" style="text-align:center; color:#e74c3c; padding:40px;">
            ‚ö†Ô∏è <strong>Configuration Required</strong><br>
            <small>Sila gantikan CONFIG.USER_ID dengan User ID anda.<br>
            Untuk dapatkan user_id, login ke Supabase Dashboard dan run query:<br>
            <code>SELECT id, username, email FROM users;</code></small>
          </td></tr>`;
        return;
      }
      
      loadBatchList();
    });
  </script>
</body>
</html>
